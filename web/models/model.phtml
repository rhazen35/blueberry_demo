<?php
/**
 * Created by PhpStorm.
 * User: Ruben Hazenbosch
 * Date: 03-Aug-16
 * Time: 20:57
 */

use app\lib\Project;
use app\enterpriseArchitecture\IOXMLEAScreenFactory;

$modelId         = ( isset( $_SESSION['xmlModelId'] ) ? $_SESSION['xmlModelId'] : "" );
$params          = array( "model_id" => $modelId );
$project         = ( new Project( "getProjectByModelId" ) )->request( $params );
$projectName     = ( isset( $project['name'] ) ? $project['name'] : "" );
$orderedElements = ( new IOXMLEAScreenFactory( "extractAndOrderElements", $modelId ) )->request( $params = null );
$totalElements   = count( $orderedElements );
$currentPage     = ( isset( $_GET['page'] ) ? $_GET['page'] : '1' );
$highestOrder    = $orderedElements['highest_order'];


?>
    <div class="newModel-head">
    <div class="title">Model Preview <?= ( !empty( $projectName ) ? "for " . $projectName : "" ) ?></div>
    </div>
<?php

if( !empty( $orderedElements ) ):

    if( $currentPage <= $highestOrder ):

        for( $i = 0; $i < $totalElements; $i++ ):

            if( !empty( $orderedElements[$i] ) ):
                /**
                 * Only print element if there is a print order, if the print order is a digit and if the print order equals the current page.
                 */
                $printOrder = ( isset( $orderedElements[$i]['printOrder'] ) ? $orderedElements[$i]['printOrder'] : "" );

                if( $orderedElements[$i]['printOrder'] !== "noPrint" && ctype_digit( $orderedElements[$i]['printOrder'] ) && $printOrder === $currentPage ):

                    /**
                     * Print root first, always contains the intro element
                     * Each element printed after the root contains a form.
                     * TODO: Might want to edit the fact that an element always contains a form!
                     */
                    ?>
                    <div class="element-Header">
                        <div class="element-Header-link">
                            <a href="http://www.quaratio.com" class="button" title="Go to quaratio.com">www.quaratio.com</a>
                        </div>
                        <div class="element-Header-img">
                            <img src="images/icons/quaratio_logo.png">
                        </div>
                    </div>
                    <?php
                    $root = ( isset( $orderedElements[$i]['isRoot'] ) ? $orderedElements[$i]['isRoot'] : "" );
                    if( $root === "true" ):
                        print_r( ( new IOXMLEAScreenFactory( "buildElementIntro", $orderedElements[$i] ) )->request( $params = null ) );
                    else:
                        print_r( ( new IOXMLEAScreenFactory( "buildElement", $orderedElements[$i] ) )->request( $params = null ) );
                    endif;

                endif;

            endif;

        endfor;

    else:

        ?>
        <div class="model-noPreview">
            <div class="model-noPreview-title">End of the line</div>
            <div class="model-noPreview-message">
                <b>Destination reached.</b>
            <div class="model-noPreview-message">
                <b>Project:</b> <?= $projectName; ?>
            </div>
        </div>
        <?php

    endif;

endif;

?>
